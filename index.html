<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PointMe</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg: #090b0f;
    --surface: #111520;
    --surface2: #171d2c;
    --border: #1e2a40;
    --border2: #2a3855;
    --north: #e84040;
    --target: #f5a623;
    --gps: #00d4aa;
    --text: #dce8f5;
    --muted: #4a607a;
    --dim: #263347;
    --success: #22c97e;
  }
  *,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); }

  .page { position: fixed; inset: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
  .page.active { opacity: 1; pointer-events: all; }

  /* HOME */
  #pgHome { align-items: center; justify-content: center; gap: 0; background: radial-gradient(ellipse 80% 60% at 50% 20%, #0d1b30 0%, var(--bg) 70%); }
  .home-glow { position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(245,166,35,0.08) 0%, transparent 70%); top: 50px; left: 50%; transform: translateX(-50%); pointer-events: none; }
  .logo { font-size: 2.8rem; font-weight: 900; letter-spacing: -2px; line-height: 1; margin-bottom: 6px; }
  .logo em { color: var(--target); font-style: normal; }
  .tagline { font-size: 0.88rem; color: var(--muted); text-align: center; line-height: 1.7; margin-bottom: 44px; max-width: 280px; }
  .home-btns { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 10px; padding: 0 24px; }
  .home-icon { font-size: 5rem; margin-bottom: 16px; filter: drop-shadow(0 0 24px rgba(245,166,35,0.35)); }

  /* BUTTONS */
  .btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; border-radius: 14px; border: none; cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 1rem; font-weight: 600; transition: all 0.15s; width: 100%; }
  .btn-primary { background: var(--target); color: #0a0c10; }
  .btn-primary:active { background: #d4901f; transform: scale(0.98); }
  .btn-outline { background: transparent; color: var(--text); border: 1.5px solid var(--border2); }
  .btn-ghost { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); font-size: 0.88rem; padding: 10px 16px; }
  .btn-sm { width: auto; padding: 9px 16px; font-size: 0.85rem; border-radius: 10px; }

  /* TOPBAR */
  .topbar { display: flex; align-items: center; gap: 10px; padding: 14px 16px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .topbar-back { background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; padding: 0 6px 0 0; line-height: 1; }
  .topbar-title { flex: 1; font-size: 1.1rem; font-weight: 700; }
  .gps-badge { display: flex; align-items: center; gap: 5px; font-size: 0.72rem; font-weight: 500; padding: 4px 9px; border-radius: 20px; border: 1px solid var(--border); color: var(--muted); }
  .gps-badge .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
  .gps-badge.good { border-color: rgba(34,201,126,0.4); color: var(--success); }
  .gps-badge.good .dot { background: var(--success); box-shadow: 0 0 6px var(--success); }
  .gps-badge.ok { border-color: rgba(245,166,35,0.4); color: var(--target); }
  .gps-badge.ok .dot { background: var(--target); }
  .gps-badge.bad { border-color: rgba(232,64,64,0.3); color: #e84040; }
  .gps-badge.bad .dot { background: #e84040; }

  /* TABS */
  .tab-bar { display: flex; gap: 4px; padding: 6px; background: var(--surface2); border-radius: 12px; margin: 12px 16px 0; border: 1px solid var(--border); flex-shrink: 0; }
  .tab { flex: 1; padding: 9px 6px; text-align: center; font-size: 0.88rem; font-weight: 600; color: var(--muted); border-radius: 9px; cursor: pointer; transition: all 0.2s; border: none; background: none; }
  .tab.active { background: var(--surface); color: var(--text); }

  /* COMPASS LEGEND */
  .compass-legend { display: flex; align-items: center; justify-content: center; gap: 20px; padding: 10px 0 0; flex-shrink: 0; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.78rem; color: var(--muted); }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
  .legend-sep { width: 1px; height: 12px; background: var(--border2); border-radius: 1px; }

  /* COMPASS CANVAS */
  .compass-container { flex-shrink: 0; display: flex; justify-content: center; padding: 8px 0; }

  /* SENSOR PILLS */
  .sensor-bar { display: flex; gap: 8px; padding: 8px 16px; flex-shrink: 0; }
  .sensor-pill { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1.5px solid var(--border); background: var(--surface2); color: var(--muted); transition: all 0.2s; user-select: none; }
  .sensor-pill.on { border-color: var(--target); color: var(--target); background: rgba(245,166,35,0.08); }

  /* SCROLL BODY */
  .scroll-body { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
  .scroll-body::-webkit-scrollbar { display: none; }

  /* FORM */
  .form-block { padding: 14px 16px; }
  .field-label { font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; display: block; margin-bottom: 6px; }
  .field-input { width: 100%; background: var(--surface2); border: 1.5px solid var(--border); color: var(--text); padding: 11px 14px; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 0.95rem; outline: none; }
  .field-input:focus { border-color: var(--target); }
  .field-input::placeholder { color: var(--muted); }
  textarea.field-input { resize: none; height: 76px; line-height: 1.5; }
  select.field-input { appearance: none; cursor: pointer; }
  select.field-input option { background: var(--surface); }
  .field-row { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
  .field { margin-bottom: 12px; }

  /* CATEGORY */
  .cat-row { display: flex; gap: 8px; }
  .cat-pill { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 10px 6px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--surface2); cursor: pointer; transition: all 0.2s; }
  .cat-pill .ei { font-size: 1.3rem; }
  .cat-pill .el { font-size: 0.68rem; font-weight: 600; color: var(--muted); }
  .cat-pill.active { border-color: var(--target); background: rgba(245,166,35,0.1); }
  .cat-pill.active .el { color: var(--target); }

  /* ALTITUDE */
  .alt-section { padding: 0 16px 14px; }
  .alt-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .alt-value { font-size: 1rem; font-weight: 700; color: var(--target); }
  .alt-track { height: 44px; background: var(--surface2); border: 1px solid var(--border); border-radius: 22px; position: relative; overflow: hidden; touch-action: none; cursor: pointer; }
  .alt-fill { position: absolute; height: 6px; top: 50%; transform: translateY(-50%); background: var(--target); border-radius: 3px; pointer-events: none; }
  .alt-center { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 2px; height: 18px; background: var(--border2); border-radius: 1px; pointer-events: none; }
  .alt-thumb { position: absolute; top: 50%; width: 34px; height: 34px; border-radius: 50%; background: var(--target); border: 3px solid var(--bg); box-shadow: 0 2px 10px rgba(0,0,0,0.5); transform: translate(-50%,-50%); pointer-events: none; }
  .alt-ends { display: flex; justify-content: space-between; font-size: 0.68rem; color: var(--muted); padding: 4px 6px 0; }

  /* DIVIDER */
  .divider { height: 1px; background: var(--border); margin: 4px 16px 12px; }
  .section-label { font-size: 0.72rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; padding: 0 16px; margin-bottom: 10px; }

  /* PIN CARDS */
  .pin-card { display: flex; align-items: flex-start; gap: 12px; padding: 13px 16px; border-bottom: 1px solid var(--border); }
  .pin-emoji { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: var(--surface2); flex-shrink: 0; }
  .pin-info { flex: 1; min-width: 0; }
  .pin-cat { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 2px; }
  .pin-msg { font-size: 0.88rem; color: var(--text); margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pin-chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .chip { font-size: 0.68rem; font-weight: 600; padding: 2px 8px; border-radius: 5px; background: var(--dim); color: var(--muted); }
  .chip.t { color: var(--target); }
  .chip.n { color: var(--north); }
  .chip.g { color: var(--gps); }
  .pin-del { background: none; border: 1px solid var(--border); color: var(--muted); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; margin-top: 4px; }
  .pin-nav-btn { background: rgba(245,166,35,0.1); border: 1px solid var(--target); color: var(--target); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; margin-top: 4px; }

  /* BOTTOM ACTION */
  .bottom-action { padding: 10px 16px 14px; border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0; background: var(--bg); }

  /* MAP */
  .map-wrap { margin: 0 16px 14px; border-radius: 14px; overflow: hidden; border: 1px solid var(--border); position: relative; }
  .map-hint { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(9,11,15,0.85); border: 1px solid var(--border2); border-radius: 20px; padding: 5px 14px; font-size: 0.75rem; color: var(--text); z-index: 500; white-space: nowrap; pointer-events: none; backdrop-filter: blur(6px); }

  /* NAVIGATE */
  #pgNav { background: var(--bg); }
  .nav-pin-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 16px; flex-shrink: 0; scrollbar-width: none; }
  .nav-pin-scroll::-webkit-scrollbar { display: none; }
  .nav-pin-btn { flex-shrink: 0; padding: 7px 14px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--muted); font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
  .nav-pin-btn.active { border-color: var(--target); color: var(--target); background: rgba(245,166,35,0.08); }

  .nav-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 6px 16px 10px; flex-shrink: 0; }
  .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; }
  .stat-l { font-size: 0.65rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 3px; }
  .stat-v { font-size: 1.1rem; font-weight: 700; line-height: 1; }
  .stat-v.t { color: var(--target); }
  .stat-v.g { color: var(--gps); }

  /* ALT VIEWER */
  .alt-viewer { display: flex; align-items: center; gap: 12px; margin: 0 16px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px; flex-shrink: 0; }
  .alt-viewer-text .lbl { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 3px; }
  .alt-viewer-text .val { font-size: 1.4rem; font-weight: 700; color: var(--target); }
  .alt-viewer-text .desc { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }

  /* NAV MSG */
  .nav-msg-box { margin: 0 16px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 13px; flex-shrink: 0; }
  .nav-msg-label { font-size: 0.68rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }

  /* GPS FIX */
  .gps-fix-box { margin: 0 16px 10px; background: rgba(0,212,170,0.06); border: 1px solid rgba(0,212,170,0.2); border-radius: 12px; padding: 13px; flex-shrink: 0; }
  .gps-fix-title { font-size: 0.72rem; font-weight: 700; color: var(--gps); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 5px; }
  .gps-fix-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.55; margin-bottom: 8px; }

  /* SHARE */
  .share-card { margin: 16px; background: var(--surface); border: 1.5px solid var(--target); border-radius: 16px; padding: 20px; text-align: center; }
  .share-label { font-size: 0.7rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .share-url { font-size: 0.82rem; color: var(--target); word-break: break-all; line-height: 1.5; margin-bottom: 14px; }
  .share-btns { display: flex; gap: 8px; justify-content: center; }

  /* JOIN */
  #pgJoin { align-items: center; justify-content: center; padding: 32px 24px; gap: 14px; background: var(--bg); }
  .join-input { width: 100%; max-width: 360px; background: var(--surface2); border: 2px solid var(--border2); color: var(--target); padding: 16px; border-radius: 12px; font-family: 'Outfit', sans-serif; font-size: 1rem; text-align: center; letter-spacing: 2px; outline: none; }
  .join-input:focus { border-color: var(--target); }

  /* TOAST */
  .toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%) translateY(-8px); background: var(--surface); border: 1px solid var(--border2); color: var(--text); padding: 10px 20px; border-radius: 10px; font-size: 0.88rem; font-weight: 500; z-index: 9999; opacity: 0; pointer-events: none; transition: all 0.25s; white-space: nowrap; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .toast.err { border-color: var(--north); color: var(--north); }

  /* PROX ALERT */
  .prox-alert { position: fixed; bottom: 24px; left: 16px; right: 16px; background: var(--success); color: #060f0c; border-radius: 14px; padding: 14px 18px; font-size: 0.95rem; font-weight: 700; z-index: 9998; display: none; text-align: center; animation: slideUp 0.3s ease; }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .leaflet-tile { filter: brightness(0.7) saturate(0.9); }
  .empty { text-align: center; padding: 30px 16px; color: var(--muted); font-size: 0.88rem; line-height: 2; }
</style>
</head>
<body>

<!-- HOME -->
<div class="page active" id="pgHome">
  <div class="home-glow"></div>
  <div class="home-icon">üß≠</div>
  <div class="logo">Point<em>Me</em></div>
  <p class="tagline">Point your phone, share the direction.<br>Friends navigate from wherever they are.</p>
  <div class="home-btns">
    <button class="btn btn-primary" onclick="App.goCreate()">+ Create &amp; Share Pins</button>
    <button class="btn btn-outline" onclick="App.goJoin()">üîó Join with Code</button>
  </div>
</div>

<!-- CREATE -->
<div class="page" id="pgCreate">
  <div class="topbar">
    <button class="topbar-back" onclick="App.goHome()">‚Üê</button>
    <span class="topbar-title">Create Pins</span>
    <div class="gps-badge" id="cGpsBadge"><div class="dot"></div><span id="cGpsText">‚Äî</span></div>
  </div>
  <div class="tab-bar">
    <button class="tab active" id="tabCompass" onclick="App.setTab('compass')">üß≠ Point Direction</button>
    <button class="tab" id="tabMap" onclick="App.setTab('map')">üó∫ Drop on Map</button>
  </div>
  <div class="scroll-body">
    <!-- COMPASS PANEL -->
    <div id="panelCompass">
      <div class="compass-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--north)"></div> North</div>
        <div class="legend-sep"></div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--target)"></div> Your Direction</div>
      </div>
      <div class="compass-container">
        <canvas id="cCanvas" width="260" height="260" style="touch-action:none;display:block"></canvas>
      </div>
      <div class="sensor-bar">
        <div class="sensor-pill on" id="compassPill" onclick="Compass.toggleLock()">
          <span>üß≠</span><span id="compassPillText">Following Phone</span>
        </div>
        <div class="sensor-pill" id="tiltPill" onclick="Tilt.toggle()">
          <span>üìê</span><span id="tiltPillText">Enable Tilt</span>
        </div>
      </div>
      <div class="alt-section">
        <div class="alt-label-row">
          <span class="field-label" style="margin:0">Vertical Angle</span>
          <span class="alt-value" id="altLabel">0¬∞</span>
        </div>
        <div class="alt-track" id="altTrack">
          <div class="alt-fill" id="altFill"></div>
          <div class="alt-center"></div>
          <div class="alt-thumb" id="altThumb"></div>
        </div>
        <div class="alt-ends"><span>‚Üô Down ‚àí90¬∞</span><span>Horizontal</span><span>‚Üó Up +90¬∞</span></div>
      </div>
    </div>
    <!-- MAP PANEL -->
    <div id="panelMap" style="display:none;padding:12px 0 0">
      <div class="map-wrap">
        <div class="map-hint" id="createMapHint">üëÜ Tap map to place pin</div>
        <div id="createMapEl" style="height:320px"></div>
      </div>
    </div>
    <!-- FORM -->
    <div class="divider"></div>
    <div class="form-block">
      <div class="field">
        <label class="field-label">Message</label>
        <textarea class="field-input" id="pinMsg" placeholder="e.g. I'm at the blue gate ‚Äî call when close!"></textarea>
      </div>
      <div class="field" id="distFieldWrap">
        <label class="field-label">Distance to target (optional)</label>
        <div class="field-row">
          <input class="field-input" type="number" id="pinDist" placeholder="e.g. 200" min="1">
          <select class="field-input" id="pinUnit">
            <option value="m">metres</option>
            <option value="km">km</option>
            <option value="mi">miles</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label class="field-label">Category</label>
        <div class="cat-row">
          <div class="cat-pill active" data-cat="meet" onclick="App.setCat(this)"><span class="ei">üìç</span><span class="el">Meet</span></div>
          <div class="cat-pill" data-cat="look" onclick="App.setCat(this)"><span class="ei">üëÅ</span><span class="el">Look</span></div>
          <div class="cat-pill" data-cat="caution" onclick="App.setCat(this)"><span class="ei">‚ö†Ô∏è</span><span class="el">Caution</span></div>
          <div class="cat-pill" data-cat="party" onclick="App.setCat(this)"><span class="ei">üéâ</span><span class="el">Party</span></div>
        </div>
      </div>
      <div class="field-row">
        <div class="field" style="margin:0">
          <label class="field-label">Expiry</label>
          <select class="field-input" id="pinExpiry">
            <option value="0">Never</option>
            <option value="60">1 hour</option>
            <option value="180">3 hours</option>
            <option value="720">12 hours</option>
          </select>
        </div>
        <div class="field" style="margin:0">
          <label class="field-label">Alert at</label>
          <select class="field-input" id="pinProx">
            <option value="0">Off</option>
            <option value="50">50 m</option>
            <option value="100" selected>100 m</option>
            <option value="250">250 m</option>
            <option value="500">500 m</option>
          </select>
        </div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="section-label">Pins Added <span id="pinCountLabel">(0)</span></div>
    <div id="createPinList"></div>
    <div class="empty" id="createEmpty">No pins yet ‚Äî set direction above and tap Add Pin</div>
  </div>
  <div class="bottom-action">
    <button class="btn btn-ghost btn-sm" style="flex:none" onclick="App.addPin()">Ôºã Add Pin</button>
    <button class="btn btn-primary" onclick="App.share()">Create &amp; Share ‚Üí</button>
  </div>
</div>

<!-- SHARE -->
<div class="page" id="pgShare">
  <div class="topbar">
    <button class="topbar-back" onclick="App.goHome()">‚Üê</button>
    <span class="topbar-title">Share Session</span>
  </div>
  <div class="scroll-body">
    <div class="share-card">
      <div class="share-label">Send this link to friends</div>
      <div class="share-url" id="shareUrl">‚Äî</div>
      <div class="share-btns">
        <button class="btn btn-primary btn-sm" onclick="App.copyLink()">üìã Copy Link</button>
        <button class="btn btn-ghost btn-sm" onclick="App.nativeShare()">‚Üó Share</button>
      </div>
    </div>
    <div class="section-label">Pins in this session</div>
    <div id="sharePinList"></div>
  </div>
  <div class="bottom-action">
    <button class="btn btn-ghost" onclick="App.goHome()">Home</button>
    <button class="btn btn-primary" onclick="App.openNav()">üß≠ Navigate ‚Üí</button>
  </div>
</div>

<!-- JOIN -->
<div class="page" id="pgJoin">
  <div class="topbar" style="position:absolute;top:0;left:0;right:0">
    <button class="topbar-back" onclick="App.goHome()">‚Üê</button>
    <span class="topbar-title">Join Session</span>
  </div>
  <div style="font-size:3.5rem;margin-top:60px">üîó</div>
  <div style="font-size:1.4rem;font-weight:700;margin-bottom:6px">Enter Code</div>
  <div style="font-size:0.85rem;color:var(--muted);text-align:center;max-width:290px;line-height:1.6;margin-bottom:6px">Paste the link or code your friend sent you</div>
  <input class="join-input" id="joinInput" type="text" placeholder="PASTE LINK OR CODE" autocomplete="off" spellcheck="false">
  <button class="btn btn-primary" style="max-width:340px;width:100%" onclick="App.join()">Open Session ‚Üí</button>
  <button class="btn btn-ghost" style="max-width:340px;width:100%" onclick="App.goHome()">Cancel</button>
</div>

<!-- NAVIGATE -->
<div class="page" id="pgNav">
  <div class="topbar">
    <button class="topbar-back" onclick="App.goHome()">‚Üê</button>
    <span class="topbar-title" id="navTitle">Navigate</span>
    <div class="gps-badge" id="nGpsBadge"><div class="dot"></div><span id="nGpsText">‚Äî</span></div>
  </div>
  <div class="scroll-body" id="navBody">
    <div class="nav-pin-scroll" id="navPinScroll"></div>
    <div class="compass-legend" style="padding:4px 0 4px">
      <div class="legend-item"><div class="legend-dot" style="background:var(--north)"></div> North</div>
      <div class="legend-sep"></div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--target)"></div> Look Here</div>
    </div>
    <div class="compass-container" style="padding:4px 0">
      <canvas id="nCanvas" width="280" height="280" style="display:block"></canvas>
    </div>
    <div class="sensor-bar" style="padding:4px 16px">
      <div class="sensor-pill on" id="navSensorPill"><span>üì±</span><span id="navSensorText">Device Compass Active</span></div>
    </div>
    <div class="nav-stats">
      <div class="stat"><div class="stat-l">Distance</div><div class="stat-v t" id="nDist">‚Äî</div></div>
      <div class="stat"><div class="stat-l">Bearing</div><div class="stat-v" id="nBearing">‚Äî</div></div>
      <div class="stat"><div class="stat-l">ETA Walk</div><div class="stat-v g" id="nETA">‚Äî</div></div>
    </div>
    <div class="alt-viewer" id="nAltViewer" style="display:none">
      <canvas id="nAltArc" width="90" height="55" style="flex-shrink:0"></canvas>
      <div class="alt-viewer-text">
        <div class="lbl">Vertical Angle</div>
        <div class="val" id="nAltVal">0¬∞</div>
        <div class="desc" id="nAltDesc">Look level</div>
      </div>
    </div>
    <div class="nav-msg-box">
      <div class="nav-msg-label">Message from sender</div>
      <div id="nMsgText" style="font-size:0.9rem;line-height:1.55">‚Äî</div>
    </div>
    <div class="gps-fix-box" id="gpsFixBox">
      <div class="gps-fix-title">üìç GPS poor or unavailable</div>
      <div class="gps-fix-desc">Tap your approximate location on the map below ‚Äî the compass will point from there to the target.</div>
      <button class="btn btn-ghost btn-sm" onclick="Nav.enableManualTap()">üìå Tap Map to Set My Location</button>
    </div>
    <div class="map-wrap" id="nMapWrap">
      <div class="map-hint" id="nMapHint" style="display:none">üëÜ Tap to set your location</div>
      <div id="navMapEl" style="height:260px"></div>
    </div>
    <div class="divider"></div>
    <div class="section-label">All Pins</div>
    <div id="navPinList" style="padding-bottom:16px"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="prox-alert" id="proxAlert"></div>

<script>
'use strict';

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const RAD = Math.PI / 180, DEG = 180 / Math.PI;
const toR = d => d * RAD, toD = r => r * DEG;
const CARDS = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
const card = d => CARDS[Math.round(((d%360)+360)%360/22.5)%16];

function haversine(a,b,c,d){
  const R=6371000,dL=toR(c-a),dN=toR(d-b);
  const x=Math.sin(dL/2)**2+Math.cos(toR(a))*Math.cos(toR(c))*Math.sin(dN/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function calcBearing(a,b,c,d){
  const dN=toR(d-b),y=Math.sin(dN)*Math.cos(toR(c));
  const x=Math.cos(toR(a))*Math.sin(toR(c))-Math.sin(toR(a))*Math.cos(toR(c))*Math.cos(dN);
  return (toD(Math.atan2(y,x))+360)%360;
}
function destPoint(lat,lng,brg,dist){
  const R=6371000,d=dist/R,b=toR(brg);
  const la=Math.asin(Math.sin(toR(lat))*Math.cos(d)+Math.cos(toR(lat))*Math.sin(d)*Math.cos(b));
  const ln=toR(lng)+Math.atan2(Math.sin(b)*Math.sin(d)*Math.cos(toR(lat)),Math.cos(d)-Math.sin(toR(lat))*Math.sin(la));
  return {lat:toD(la),lng:toD(ln)};
}
function fmtDist(m){return m<1000?Math.round(m)+' m':(m/1000).toFixed(1)+' km';}
function fmtETA(m){const min=Math.ceil(m/80);return min<60?min+' min':Math.floor(min/60)+'h '+(min%60)+'m';}

const CAT={meet:'üìç',look:'üëÅ',caution:'‚ö†Ô∏è',party:'üéâ'};
const CATCOL={meet:'#00d4aa',look:'#f5a623',caution:'#ed8936',party:'#b794f4'};
const enc=o=>btoa(encodeURIComponent(JSON.stringify(o)));
const dec=s=>{try{return JSON.parse(decodeURIComponent(atob(s.trim())));}catch{return null;}};

let _tt;
function showToast(msg,err=false){
  const el=$('toast');el.textContent=msg;
  el.className='toast show'+(err?' err':'');
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),2800);
}
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $(id).classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ GPS ‚îÄ‚îÄ‚îÄ
const GPS={
  lat:null,lng:null,acc:null,
  start(){
    if(!navigator.geolocation)return;
    navigator.geolocation.watchPosition(p=>{
      this.lat=p.coords.latitude;this.lng=p.coords.longitude;this.acc=p.coords.accuracy;
      this._badge();
      Nav.onGPS();
    },()=>this._badge(),{enableHighAccuracy:true,maximumAge:3000,timeout:15000});
  },
  _badge(){
    [['cGpsBadge','cGpsText'],['nGpsBadge','nGpsText']].forEach(([b,t])=>{
      const be=$(b),te=$(t);if(!be)return;
      if(this.lat===null){be.className='gps-badge bad';te.textContent='No GPS';return;}
      const lbl='¬±'+Math.round(this.acc)+'m';
      if(this.acc<20){be.className='gps-badge good';te.textContent=lbl;}
      else if(this.acc<100){be.className='gps-badge ok';te.textContent=lbl;}
      else{be.className='gps-badge bad';te.textContent=lbl;}
    });
  }
};

// ‚îÄ‚îÄ‚îÄ ORIENTATION ‚îÄ‚îÄ‚îÄ
const Orient={
  heading:null,pitch:null,
  _cbs:[],
  active:false,
  start(cb){
    if(cb)this._cbs.push(cb);
    if(this.active)return;
    this.active=true;
    const h=e=>{
      // Heading
      let head=null;
      if(typeof e.webkitCompassHeading==='number')head=e.webkitCompassHeading;
      else if(e.absolute&&typeof e.alpha==='number')head=(360-e.alpha)%360;
      else if(typeof e.alpha==='number')head=(360-e.alpha)%360;
      if(head!==null){
        if(this.heading===null){this.heading=head;}
        else{let d=head-this.heading;if(d>180)d-=360;if(d<-180)d+=360;this.heading=(this.heading+d*0.15+360)%360;}
      }
      // Pitch ‚Äî beta: ~90 upright, <90 = forward tilt, >90 = back tilt
      if(typeof e.beta==='number'){
        const raw=e.beta-90;
        this.pitch=this.pitch===null?raw:this.pitch+(raw-this.pitch)*0.2;
      }
      this._cbs.forEach(f=>f(this.heading,this.pitch));
    };
    window.addEventListener('deviceorientationabsolute',h,true);
    window.addEventListener('deviceorientation',h,true);
  },
  requestAndStart(cb){
    if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(s=>{
        if(s==='granted')this.start(cb);
        else showToast('Compass permission denied ‚Äî drag needle manually',true);
      }).catch(()=>showToast('Could not get compass access',true));
    } else {
      this.start(cb);
    }
  }
};

// ‚îÄ‚îÄ‚îÄ COMPASS DRAWING ‚îÄ‚îÄ‚îÄ
function drawCompassCanvas(id, heading, targetBearing, opts){
  const canvas=$(id);if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2,R=Math.min(cx,cy)-6;
  ctx.clearRect(0,0,W,H);

  // Outer glow
  const gr=ctx.createRadialGradient(cx,cy,R*0.5,cx,cy,R);
  gr.addColorStop(0,'rgba(245,166,35,0)');gr.addColorStop(1,'rgba(245,166,35,0.05)');
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=gr;ctx.fill();

  // ‚îÄ‚îÄ ROTATE CANVAS for north-up ‚îÄ‚îÄ
  // All ticks/labels are drawn in rotated space so they represent absolute directions.
  // Needles are drawn in screen space (not rotated).
  ctx.save();
  ctx.translate(cx,cy);
  if(heading!==null)ctx.rotate(toR(-heading));

  // Rings
  ctx.beginPath();ctx.arc(0,0,R,0,Math.PI*2);ctx.strokeStyle='#2a3855';ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();ctx.arc(0,0,R*0.62,0,Math.PI*2);ctx.strokeStyle='rgba(42,56,85,0.35)';ctx.lineWidth=1;ctx.stroke();

  // Ticks
  for(let i=0;i<360;i+=5){
    const a=toR(i-90);
    const big=i%90===0,med=i%30===0;
    const r0=big?R-20:med?R-14:R-8;
    ctx.beginPath();ctx.moveTo(Math.cos(a)*r0,Math.sin(a)*r0);ctx.lineTo(Math.cos(a)*(R-2),Math.sin(a)*(R-2));
    ctx.strokeStyle=big?'rgba(200,215,235,0.5)':'rgba(42,56,85,0.9)';ctx.lineWidth=big?2:1;ctx.stroke();
  }

  // Cardinal letters
  [['N',0,'#e84040'],['E',90,'#4a607a'],['S',180,'#4a607a'],['W',270,'#4a607a']].forEach(([l,deg,col])=>{
    const a=toR(deg-90);
    ctx.font='bold 13px Outfit,sans-serif';ctx.fillStyle=col;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(l,Math.cos(a)*(R-28),Math.sin(a)*(R-28));
  });

  ctx.restore(); // end rotated section

  // ‚îÄ‚îÄ NORTH NEEDLE (always 12 o'clock = up on screen) ‚îÄ‚îÄ
  _drawNeedle(ctx,cx,cy,R,0,'#e84040',8,0.88,true);

  // ‚îÄ‚îÄ TARGET NEEDLE (screen angle = absolute bearing minus device heading) ‚îÄ‚îÄ
  let sa=(targetBearing-(heading||0)+360)%360;
  _drawNeedle(ctx,cx,cy,R,sa,'#f5a623',9,1.0,false);

  // Center hub
  ctx.beginPath();ctx.arc(cx,cy,11,0,Math.PI*2);ctx.fillStyle='#090b0f';ctx.fill();
  ctx.strokeStyle='#4a607a';ctx.lineWidth=1.5;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,4.5,0,Math.PI*2);ctx.fillStyle='#dce8f5';ctx.fill();

  // Center text
  if(opts&&opts.centerText){
    ctx.fillStyle='rgba(220,232,245,0.45)';ctx.font='600 13px Outfit,sans-serif';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(opts.centerText,cx,cy+24);
  }
}

function _drawNeedle(ctx,cx,cy,R,angleDeg,color,hw,alpha,dimBack){
  const a=toR(angleDeg-90);
  const tip=R-14,back=R*0.3;
  const tx=cx+Math.cos(a)*tip,ty=cy+Math.sin(a)*tip;
  const lx=cx+Math.cos(a+Math.PI/2)*hw,ly=cy+Math.sin(a+Math.PI/2)*hw;
  const rx=cx+Math.cos(a-Math.PI/2)*hw,ry=cy+Math.sin(a-Math.PI/2)*hw;
  const bx=cx-Math.cos(a)*back,by=cy-Math.sin(a)*back;
  ctx.save();
  ctx.globalAlpha=alpha;ctx.shadowColor=color;ctx.shadowBlur=dimBack?8:22;
  ctx.beginPath();ctx.moveTo(tx,ty);ctx.lineTo(lx,ly);ctx.lineTo(bx,by);ctx.lineTo(rx,ry);ctx.closePath();
  ctx.fillStyle=color;ctx.fill();
  ctx.shadowBlur=0;ctx.globalAlpha=alpha*0.45;
  ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(bx,by);ctx.lineTo(rx,ry);ctx.closePath();
  ctx.fillStyle=dimBack?'#6a1515':'#7a5010';ctx.fill();
  ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ CREATOR COMPASS ‚îÄ‚îÄ‚îÄ
const Compass={
  locked:true,
  targetBearing:0,
  _drag:false,

  init(){
    const c=$('cCanvas');if(!c||c._init)return;c._init=true;
    const angle=e=>{
      const r=c.getBoundingClientRect(),px=(e.touches?e.touches[0].clientX:e.clientX)-r.left-r.width/2,py=(e.touches?e.touches[0].clientY:e.clientY)-r.top-r.height/2;
      return (toD(Math.atan2(px,-py))+360)%360;
    };
    ['mousedown','touchstart'].forEach(ev=>c.addEventListener(ev,e=>{
      this._drag=true;this.locked=false;this._lockUI();
      this.targetBearing=angle(e);e.preventDefault();
    },{passive:false}));
    ['mousemove','touchmove'].forEach(ev=>window.addEventListener(ev,e=>{
      if(!this._drag)return;this.targetBearing=angle(e);
    }));
    ['mouseup','touchend','touchcancel'].forEach(ev=>window.addEventListener(ev,()=>this._drag=false));
    // Auto-start device compass
    Orient.requestAndStart((h,p)=>{
      if(this.locked&&h!==null)this.targetBearing=h;
      Tilt.onPitch(p);
    });
  },

  toggleLock(){
    this.locked=!this.locked;this._lockUI();
    showToast(this.locked?'Following phone direction':'Manual ‚Äî drag the orange needle');
  },

  _lockUI(){
    const pill=$('compassPill'),text=$('compassPillText');
    if(this.locked){pill.className='sensor-pill on';text.textContent='Following Phone';}
    else{pill.className='sensor-pill';text.textContent='Manual (drag needle)';}
  },

  draw(){drawCompassCanvas('cCanvas',Orient.heading,this.targetBearing);}
};

// ‚îÄ‚îÄ‚îÄ TILT / ALTITUDE ‚îÄ‚îÄ‚îÄ
const Tilt={
  angle:0,fromSensor:false,_drag:false,

  init(){
    const track=$('altTrack');if(!track||track._init)return;track._init=true;
    const get=clientX=>{const r=track.getBoundingClientRect();return Math.round(Math.max(-90,Math.min(90,(Math.max(0,Math.min(1,(clientX-r.left)/r.width))-0.5)*180)));};
    ['mousedown','touchstart'].forEach(ev=>track.addEventListener(ev,e=>{
      if(this.fromSensor)return;this._drag=true;
      this.angle=get(e.touches?e.touches[0].clientX:e.clientX);this._ui();e.preventDefault();
    },{passive:false}));
    ['mousemove','touchmove'].forEach(ev=>window.addEventListener(ev,e=>{
      if(!this._drag||this.fromSensor)return;this.angle=get(e.touches?e.touches[0].clientX:e.clientX);this._ui();
    }));
    ['mouseup','touchend'].forEach(ev=>window.addEventListener(ev,()=>this._drag=false));
    this._ui();
  },

  toggle(){
    this.fromSensor=!this.fromSensor;
    const pill=$('tiltPill'),text=$('tiltPillText');
    if(this.fromSensor){pill.className='sensor-pill on';text.textContent='Tilt ON ‚Äî tilt phone';showToast('üìê Tilt phone forward/back to adjust vertical angle');}
    else{pill.className='sensor-pill';text.textContent='Enable Tilt';showToast('Manual slider mode');}
  },

  onPitch(p){if(!this.fromSensor||p===null)return;this.angle=Math.round(Math.max(-90,Math.min(90,p)));this._ui();},

  _ui(){
    const thumb=$('altThumb'),fill=$('altFill'),label=$('altLabel'),track=$('altTrack');
    if(!thumb||!track)return;
    const W=track.offsetWidth||300,frac=(this.angle+90)/180,x=frac*W,cx=W/2;
    thumb.style.left=x+'px';
    if(x>=cx){fill.style.left=cx+'px';fill.style.width=(x-cx)+'px';}
    else{fill.style.left=x+'px';fill.style.width=(cx-x)+'px';}
    if(label)label.textContent=(this.angle>0?'+':'')+this.angle+'¬∞';
  }
};

// ‚îÄ‚îÄ‚îÄ CREATOR MAP ‚îÄ‚îÄ‚îÄ
const CMap={
  map:null,marker:null,lat:null,lng:null,
  init(){
    if(this.map){setTimeout(()=>this.map.invalidateSize(),80);return;}
    const center=GPS.lat?[GPS.lat,GPS.lng]:[20.5937,78.9629];
    this.map=L.map('createMapEl',{zoomControl:true,attributionControl:false}).setView(center,GPS.lat?15:5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_matter/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(this.map);
    if(GPS.lat){
      const ic=L.divIcon({html:'<div style="width:12px;height:12px;background:#00d4aa;border-radius:50%;border:2.5px solid white;box-shadow:0 0 8px #00d4aa"></div>',iconSize:[12,12],iconAnchor:[6,6],className:''});
      L.marker([GPS.lat,GPS.lng],{icon:ic}).addTo(this.map).bindPopup('You');
    }
    this.map.on('click',e=>{
      const{lat,lng}=e.latlng;this.lat=lat;this.lng=lng;
      if(this.marker)this.map.removeLayer(this.marker);
      const ic=L.divIcon({html:'<div style="font-size:26px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.8))">üìç</div>',iconSize:[26,30],iconAnchor:[13,28],className:''});
      this.marker=L.marker([lat,lng],{icon:ic}).addTo(this.map);
      $('createMapHint').textContent='‚úì Pin placed ‚Äî tap again to move';
      showToast(`üìç ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
    });
    setTimeout(()=>this.map.invalidateSize(),100);
  },
  clear(){this.lat=null;this.lng=null;if(this.marker&&this.map){this.map.removeLayer(this.marker);this.marker=null;}$('createMapHint').textContent='üëÜ Tap map to place pin';}
};

// ‚îÄ‚îÄ‚îÄ NAVIGATE ‚îÄ‚îÄ‚îÄ
const Nav={
  session:null,pinIdx:0,map:null,
  userMk:null,pinMks:[],
  manLat:null,manLng:null,
  tapMode:false,proxFired:{},
  _loopId:null,

  load(session){
    this.session=session;this.pinIdx=0;this.manLat=null;this.manLng=null;this.proxFired={};
    showPage('pgNav');
    $('navTitle').textContent=session.name||'Navigate';
    Orient.requestAndStart(()=>{});
    this._renderSelector();this._renderList();this._initMap();
    this.selectPin(0);this._startLoop();
  },

  _startLoop(){
    if(this._loopId)cancelAnimationFrame(this._loopId);
    const loop=()=>{
      if(!$('pgNav').classList.contains('active')){this._loopId=null;return;}
      this._drawCompass();this._updateStats();
      this._loopId=requestAnimationFrame(loop);
    };
    this._loopId=requestAnimationFrame(loop);
  },

  _getTarget(){
    const pin=this.session.pins[this.pinIdx];
    const myLat=this.manLat??GPS.lat,myLng=this.manLng??GPS.lng;
    let b=pin.bearing??0,dist=null;
    if(pin.lat!==null&&myLat!==null){dist=haversine(myLat,myLng,pin.lat,pin.lng);b=calcBearing(myLat,myLng,pin.lat,pin.lng);}
    return{b,dist,pin,myLat,myLng};
  },

  _drawCompass(){
    if(!this.session)return;
    const{b,dist}=this._getTarget();
    drawCompassCanvas('nCanvas',Orient.heading,b,{centerText:dist!==null?fmtDist(dist):''});
  },

  _updateStats(){
    if(!this.session)return;
    const{b,dist}=this._getTarget();
    $('nDist').textContent=dist!==null?fmtDist(dist):'‚Äî';
    $('nBearing').textContent=Math.round(b)+'¬∞ '+card(b);
    $('nETA').textContent=dist!==null?fmtETA(dist):'‚Äî';
    if(dist!==null)this._checkProx(dist);
  },

  _checkProx(dist){
    const pin=this.session.pins[this.pinIdx];
    if(!pin.prox||this.proxFired[pin.id])return;
    if(dist<=pin.prox){
      this.proxFired[pin.id]=true;
      const a=$('proxAlert');
      a.textContent=`${CAT[pin.cat]} ${fmtDist(dist)} away! "${pin.msg.substring(0,30)}"`;
      a.style.display='block';
      if(navigator.vibrate)navigator.vibrate([200,100,300]);
      setTimeout(()=>{a.style.display='none';delete this.proxFired[pin.id];},5000);
    }
  },

  selectPin(i){
    this.pinIdx=i;
    document.querySelectorAll('.nav-pin-btn').forEach((b,j)=>b.classList.toggle('active',j===i));
    const pin=this.session.pins[i];
    $('nMsgText').textContent=pin.msg||'‚Äî';
    const hasAlt=pin.alt&&pin.alt!==0;
    $('nAltViewer').style.display=hasAlt?'flex':'none';
    if(hasAlt){
      $('nAltVal').textContent=(pin.alt>0?'+':'')+pin.alt+'¬∞';
      $('nAltDesc').textContent=pin.alt>0?'Tilt phone up to aim at target':pin.alt<0?'Tilt phone down to aim at target':'Hold phone level to aim at target';
      this._drawAltArc(pin.alt);
    }
    this._centerMap();this._updateLocFix();
  },

  _drawAltArc(angle){
    const c=$('nAltArc');if(!c)return;
    const ctx=c.getContext('2d'),W=90,H=55,cx=W/2,cy=H-4,r=36;
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();ctx.arc(cx,cy,r,Math.PI,0);ctx.strokeStyle='#1e2a40';ctx.lineWidth=4;ctx.stroke();
    ctx.beginPath();ctx.moveTo(6,cy);ctx.lineTo(W-6,cy);ctx.strokeStyle='#2a3855';ctx.lineWidth=1;ctx.stroke();
    const endA=Math.PI-toR(angle);
    const [sa,ea,ccw]=[angle>=0?endA:Math.PI,angle>=0?Math.PI:endA,angle<0];
    ctx.beginPath();ctx.arc(cx,cy,r,sa,ea,ccw);ctx.strokeStyle='#f5a623';ctx.lineWidth=4;ctx.stroke();
    ctx.beginPath();ctx.arc(cx+Math.cos(endA)*r,cy+Math.sin(endA)*r,6,0,Math.PI*2);ctx.fillStyle='#f5a623';ctx.fill();
  },

  _renderSelector(){
    $('navPinScroll').innerHTML=this.session.pins.map((p,i)=>
      `<button class="nav-pin-btn${i===0?' active':''}" onclick="Nav.selectPin(${i})">${CAT[p.cat]} Pin ${i+1}</button>`
    ).join('');
  },

  _renderList(){
    $('navPinList').innerHTML=this.session.pins.map((p,i)=>_pinCard(p,i,false)).join('');
  },

  _initMap(){
    if(this.map){this.map.remove();this.map=null;}this.pinMks=[];
    const fp=this.session.pins.find(p=>p.lat!==null);
    const center=fp?[fp.lat,fp.lng]:GPS.lat?[GPS.lat,GPS.lng]:[20.5937,78.9629];
    this.map=L.map('navMapEl',{zoomControl:false,attributionControl:false}).setView(center,14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_matter/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(this.map);
    this.session.pins.forEach((p,i)=>{
      if(p.lat===null)return;
      const col=CATCOL[p.cat]||'#f5a623';
      const ic=L.divIcon({html:`<div style="background:${col};width:14px;height:14px;border-radius:50%;border:2.5px solid white;box-shadow:0 0 8px ${col}88"></div>`,iconSize:[14,14],iconAnchor:[7,7],className:''});
      L.marker([p.lat,p.lng],{icon:ic}).addTo(this.map).bindPopup(`<b>${CAT[p.cat]} Pin ${i+1}</b><br>${p.msg}`);
    });
    this.map.on('click',e=>{
      if(!this.tapMode)return;
      this.manLat=e.latlng.lat;this.manLng=e.latlng.lng;
      this.tapMode=false;$('nMapHint').style.display='none';$('navMapEl').style.outline='none';
      this._updateUserMarker();this._updateLocFix();
      showToast('üìç Your location set ‚Äî compass updated!');
    });
    this._updateUserMarker();
    setTimeout(()=>this.map.invalidateSize(),150);
  },

  _updateUserMarker(){
    if(!this.map)return;
    const lat=this.manLat??GPS.lat,lng=this.manLng??GPS.lng;
    if(lat===null)return;
    if(this.userMk)this.map.removeLayer(this.userMk);
    const ic=L.divIcon({html:'<div style="width:16px;height:16px;background:#00d4aa;border-radius:50%;border:3px solid white;box-shadow:0 0 10px #00d4aa88"></div>',iconSize:[16,16],iconAnchor:[8,8],className:''});
    this.userMk=L.marker([lat,lng],{icon:ic,zIndexOffset:200}).addTo(this.map).bindPopup('You');
  },

  _centerMap(){
    if(!this.map)return;
    const pin=this.session.pins[this.pinIdx];
    const myLat=this.manLat??GPS.lat,myLng=this.manLng??GPS.lng;
    const pts=[];
    if(pin.lat!==null)pts.push([pin.lat,pin.lng]);
    if(myLat!==null)pts.push([myLat,myLng]);
    if(pts.length>=2)this.map.fitBounds(L.latLngBounds(pts),{padding:[40,40]});
    else if(pts.length===1)this.map.setView(pts[0],15);
    setTimeout(()=>this.map.invalidateSize(),100);
  },

  enableManualTap(){
    this.tapMode=true;$('nMapHint').style.display='block';$('navMapEl').style.outline='2px solid var(--gps)';
    showToast('üëÜ Tap map to set your location');
    $('navMapEl').scrollIntoView({behavior:'smooth',block:'center'});
  },

  onGPS(){this._updateUserMarker();this._updateLocFix();},

  _updateLocFix(){
    const ok=(GPS.lat!==null&&(GPS.acc||999)<150)||(this.manLat!==null);
    $('gpsFixBox').style.display=ok?'none':'';
  }
};

// ‚îÄ‚îÄ‚îÄ PIN CARD ‚îÄ‚îÄ‚îÄ
function _pinCard(p,i,del){
  const b=p.bearing!==null?`<span class="chip t">${Math.round(p.bearing)}¬∞ ${card(p.bearing)}</span>`:'';
  const d=p.dist?`<span class="chip">${fmtDist(p.dist)}</span>`:'';
  const a=p.alt?`<span class="chip g">${p.alt>0?'+':''}${p.alt}¬∞</span>`:'';
  const pos=p.lat!==null?`<span class="chip">${p.lat.toFixed(4)},${p.lng.toFixed(4)}</span>`:`<span class="chip n">dir only</span>`;
  const btn=del?`<button class="pin-del" onclick="App.deletePin(${i})">‚úï</button>`:
    `<button class="pin-nav-btn" onclick="Nav.selectPin(${i})">‚ñ∂</button>`;
  return `<div class="pin-card">
    <div class="pin-emoji">${CAT[p.cat]}</div>
    <div class="pin-info">
      <div class="pin-cat" style="color:${CATCOL[p.cat]}">${p.cat.charAt(0).toUpperCase()+p.cat.slice(1)}</div>
      <div class="pin-msg">${p.msg}</div>
      <div class="pin-chips">${b}${d}${a}${pos}</div>
    </div>${btn}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ
const App={
  session:null,pins:[],tab:'compass',cat:'meet',

  goHome(){showPage('pgHome');},

  goCreate(){
    this.pins=[];this._renderPins();
    showPage('pgCreate');
    setTimeout(()=>{Compass.init();Tilt.init();},120);
  },

  goJoin(){$('joinInput').value='';showPage('pgJoin');},

  setTab(t){
    this.tab=t;
    ['Compass','Map'].forEach(x=>{
      const id='tab'+x,pid='panel'+x;
      $(id)?.classList.toggle('active',x.toLowerCase()===t);
      const el=$(pid);if(el)el.style.display=x.toLowerCase()===t?'':'none';
    });
    $('distFieldWrap').style.display=t==='compass'?'':'none';
    if(t==='map')setTimeout(()=>CMap.init(),60);
  },

  setCat(el){
    this.cat=el.dataset.cat;
    document.querySelectorAll('.cat-pill').forEach(p=>p.classList.remove('active'));
    el.classList.add('active');
  },

  addPin(){
    const msg=$('pinMsg').value.trim();
    const exp=parseInt($('pinExpiry').value);
    const prox=parseInt($('pinProx').value);
    const alt=Tilt.angle;
    let lat=null,lng=null,brg=null,dist=null;

    if(this.tab==='compass'){
      brg=Math.round(Compass.targetBearing);
      const dv=parseFloat($('pinDist').value);
      if(!isNaN(dv)&&dv>0){
        if(GPS.lat===null){showToast('GPS needed to compute distance direction',true);return;}
        const unit=$('pinUnit').value;
        dist=unit==='m'?dv:unit==='km'?dv*1000:dv*1609.34;
        const dp=destPoint(GPS.lat,GPS.lng,brg,dist);
        lat=dp.lat;lng=dp.lng;
      }
    } else {
      if(CMap.lat===null){showToast('Tap the map to place a pin first',true);return;}
      lat=CMap.lat;lng=CMap.lng;
      if(GPS.lat!==null)brg=Math.round(calcBearing(GPS.lat,GPS.lng,lat,lng));
      CMap.clear();
    }

    this.pins.push({id:Date.now().toString(36),lat,lng,bearing:brg,dist,alt,msg:msg||'No message',cat:this.cat,expiry:exp>0?Date.now()+exp*60000:0,prox});
    $('pinMsg').value='';$('pinDist').value='';
    this._renderPins();showToast(`${CAT[this.cat]} Pin added!`);
  },

  deletePin(i){this.pins.splice(i,1);this._renderPins();},

  _renderPins(){
    const list=$('createPinList'),empty=$('createEmpty');
    $('pinCountLabel').textContent=`(${this.pins.length})`;
    if(!this.pins.length){list.innerHTML='';empty.style.display='';return;}
    empty.style.display='none';
    list.innerHTML=this.pins.map((p,i)=>_pinCard(p,i,true)).join('');
  },

  share(){
    if(!this.pins.length){showToast('Add at least one pin first!',true);return;}
    const name=prompt('Session name (e.g. "Party at Raj\'s"):','My Session')||'My Session';
    this.session={name,pins:this.pins,created:Date.now(),creatorLat:GPS.lat,creatorLng:GPS.lng};
    const code=enc(this.session);
    const url=location.origin+location.pathname+'#'+code;
    $('shareUrl').textContent=url;$('shareUrl').dataset.url=url;
    $('sharePinList').innerHTML=this.pins.map((p,i)=>_pinCard(p,i,false)).join('');
    showPage('pgShare');
  },

  copyLink(){
    const url=$('shareUrl').dataset.url;
    navigator.clipboard.writeText(url).then(()=>showToast('Link copied!')).catch(()=>prompt('Copy:',url));
  },

  nativeShare(){
    const url=$('shareUrl').dataset.url;
    if(navigator.share)navigator.share({title:'PointMe',text:'Navigate with me!',url});
    else this.copyLink();
  },

  openNav(){if(this.session)Nav.load(this.session);},

  join(){
    let raw=$('joinInput').value.trim();
    const h=raw.indexOf('#');if(h!==-1)raw=raw.substring(h+1);
    const sess=dec(raw);
    if(!sess||!Array.isArray(sess.pins)){showToast('Invalid code or link',true);return;}
    Nav.load(sess);
  }
};

// ‚îÄ‚îÄ‚îÄ RENDER LOOP (creator) ‚îÄ‚îÄ‚îÄ
(function loop(){
  if($('pgCreate').classList.contains('active'))Compass.draw();
  requestAnimationFrame(loop);
})();

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  GPS.start();
  const hash=location.hash.slice(1);
  if(hash.length>20){const s=dec(hash);if(s&&Array.isArray(s.pins)){setTimeout(()=>Nav.load(s),300);return;}}
});

window.addEventListener('resize',()=>{
  if(Nav.map)Nav.map.invalidateSize();
  if(CMap.map)CMap.map.invalidateSize();
  Tilt._ui();
});
</script>
</body>
</html>
